# C++ 成员函数在线程池中的调用机制

## 1. 问题背景

在 `RknnPool` 的 `put()` 函数中有这样一行代码：

```cpp
m_futures.push(m_pool->submit(&rknnModel::infer, m_models[modelId], inputData));
```

**问题**：
- 这是将 `infer` 成员函数放在线程池中执行吗？
- 成员函数中使用了成员变量，这些成员变量会一并传过去吗？

---

## 2. 代码分解

```cpp
m_pool->submit(&rknnModel::infer, m_models[modelId], inputData);
```

| 部分 | 类型 | 含义 |
|------|------|------|
| `&rknnModel::infer` | 成员函数指针 | 指向 `infer` 函数的地址 |
| `m_models[modelId]` | `shared_ptr<rknnModel>` | 对象实例的智能指针 |
| `inputData` | `cv::Mat` | 函数的输入参数 |

---

## 3. 成员函数的本质

### 3.1 你写的代码

```cpp
class YOLO5 : public rknn::Model {
private:
    cv::Mat m_img;              // 成员变量
    rknn_context m_rknnCtx;     // 成员变量
    DetectParam m_detectParam;  // 成员变量

public:
    object_detect_result_list infer(cv::Mat img) {
        // 函数内部使用成员变量
        m_img = img;
        rknn_run(m_rknnCtx, nullptr);
        // ...
    }
};
```

### 3.2 编译器实际处理

编译器会将成员函数转换为带有隐式 `this` 指针的普通函数：

```cpp
// 编译器内部生成的等价代码（简化示意）
object_detect_result_list YOLO5_infer(YOLO5* this, cv::Mat img) {
    this->m_img = img;                    // 通过 this 访问 m_img
    rknn_run(this->m_rknnCtx, nullptr);   // 通过 this 访问 m_rknnCtx
    // ...
}
```

**关键点**：
- 每个成员函数都有一个隐藏的 `this` 参数
- 所有成员变量都通过 `this` 指针访问
- `this` 指向调用该函数的对象实例

---

## 4. submit 的调用等价关系

```cpp
// 线程池提交代码
m_pool->submit(&rknnModel::infer, m_models[modelId], inputData);

// 等价于告诉线程池执行
m_models[modelId]->infer(inputData);

// 进一步等价于（展开 this 指针）
rknnModel::infer(m_models[modelId].get(), inputData);
//                ↑ this 指针              ↑ 参数
```

---

## 5. 内存布局图解

### 5.1 对象与指针的关系

```
┌─────────────────────────────────────────────────────────────────────┐
│                           内存布局                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│   RknnPool 对象                                                     │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │  m_models (vector<shared_ptr>)                              │  │
│   │                                                             │  │
│   │  [0] ─────────────────────────┐                             │  │
│   │  [1] ──────────────────────┐  │                             │  │
│   │  [2] ───────────────────┐  │  │                             │  │
│   └─────────────────────────│──│──│─────────────────────────────┘  │
│                             │  │  │                                 │
│                             ▼  │  │                                 │
│                    ┌───────────────────┐                           │
│                    │  YOLO5 实例 #2    │ ← 堆内存中的对象           │
│                    │  (NPU Core 2)     │                           │
│                    │                   │                           │
│                    │  m_img            │                           │
│                    │  m_rknnCtx        │                           │
│                    │  m_detectParam    │                           │
│                    │  m_inferenceMtx   │                           │
│                    └───────────────────┘                           │
│                                │                                    │
│                             ▼  │                                    │
│                    ┌───────────────────┐                           │
│                    │  YOLO5 实例 #1    │                           │
│                    │  (NPU Core 1)     │                           │
│                    │  ...              │                           │
│                    └───────────────────┘                           │
│                                   │                                 │
│                                   ▼                                 │
│                    ┌───────────────────┐                           │
│                    │  YOLO5 实例 #0    │                           │
│                    │  (NPU Core 0)     │                           │
│                    │  ...              │                           │
│                    └───────────────────┘                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 5.2 线程池调用时的数据流

```
┌────────────────────┐                    ┌────────────────────┐
│      主线程        │                    │     工作线程        │
│                    │                    │                    │
│  调用 submit()     │                    │                    │
│        │           │                    │                    │
│        ▼           │                    │                    │
│  传递参数：        │    ─────────────→  │  接收参数：        │
│  - 函数指针        │    (任务队列)      │  - 函数指针        │
│  - shared_ptr      │                    │  - shared_ptr      │
│  - inputData       │                    │  - inputData       │
│                    │                    │        │           │
└────────────────────┘                    │        ▼           │
                                          │  执行调用：        │
                                          │  ptr->infer(data)  │
                                          │        │           │
                                          └────────│───────────┘
                                                   │
                                                   ▼
                                          ┌────────────────────┐
                                          │   YOLO5 对象实例   │
                                          │   (堆内存，唯一)   │
                                          │                    │
                                          │   访问成员变量：   │
                                          │   this->m_img      │
                                          │   this->m_rknnCtx  │
                                          │   ...              │
                                          └────────────────────┘
```

---

## 6. 关键问题解答

### Q1: 成员变量会被"复制传递"吗？

**不会！**

传递的是**对象指针**（`shared_ptr`），不是成员变量的副本。

```cpp
// 这是传递的内容
┌─────────────────────────────────────────────┐
│  传递到线程池的参数：                        │
│                                             │
│  1. &rknnModel::infer  →  函数地址（8字节） │
│  2. m_models[modelId]  →  指针（8字节）     │
│  3. inputData          →  cv::Mat（复制）   │
│                                             │
│  成员变量 m_img, m_rknnCtx 等：不传递！     │
│  它们存在于指针指向的对象中                  │
└─────────────────────────────────────────────┘
```

### Q2: 成员变量在哪里？

成员变量存储在**堆内存中的对象实例**里，通过 `this` 指针（即传入的 `shared_ptr`）访问。

```cpp
// 工作线程执行时
m_models[modelId]->infer(inputData);
        │
        │  this = m_models[modelId].get()
        ▼
┌─────────────────────────┐
│  YOLO5 对象 @ 0x12345   │  ← this 指向这里
│                         │
│  m_img      @ 0x12345+0 │  ← this->m_img
│  m_rknnCtx  @ 0x12345+X │  ← this->m_rknnCtx
│  ...                    │
└─────────────────────────┘
```

### Q3: 多线程访问同一对象会怎样？

如果多个线程同时调用同一对象的成员函数，会产生**竞争条件**：

```
线程A: this->m_img = imgA;  ──┐
                              ├──→ 数据竞争！结果不确定
线程B: this->m_img = imgB;  ──┘
```

**这就是为什么需要互斥锁**：

```cpp
rknn::ModelResult rknn::Model::inference(cv::Mat img) {
    // 加锁保护成员变量
    std::lock_guard<std::mutex> lock(m_inferenceMtx);

    m_img = img.clone();  // 安全写入
    // ...
}
```

---

## 7. 完整调用流程

```
┌─────────────────────────────────────────────────────────────────────┐
│  1. 主线程调用 put(inputData)                                        │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  2. submit(&rknnModel::infer, m_models[modelId], inputData)         │
│                                                                     │
│     打包成任务：                                                     │
│     ┌─────────────────────────────────────────────────────────┐    │
│     │  Task = [&infer, shared_ptr, inputData]                 │    │
│     │         函数指针   对象指针    参数副本                   │    │
│     └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  3. 任务放入队列，返回 future                                        │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  4. 工作线程从队列取出任务                                           │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  5. 执行任务：shared_ptr->infer(inputData)                          │
│                                                                     │
│     相当于：                                                         │
│     YOLO5* this = shared_ptr.get();                                 │
│     this->infer(inputData);                                         │
│                                                                     │
│     函数内部通过 this 访问成员变量：                                  │
│     this->m_img = inputData;                                        │
│     this->m_rknnCtx ...                                             │
└─────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────┐
│  6. 返回结果，存入 future                                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 8. 总结

### 核心概念

| 概念 | 说明 |
|------|------|
| 成员函数 | 隐含 `this` 参数，通过 `this` 访问成员变量 |
| 传递方式 | 传递**对象指针**，不是成员变量副本 |
| 成员变量位置 | 在堆内存中的对象实例里 |
| 访问方式 | 通过 `this` 指针间接访问 |

### 代码等价关系

```cpp
// 你写的代码
m_pool->submit(&rknnModel::infer, m_models[modelId], inputData);

// 线程池内部执行
m_models[modelId]->infer(inputData);

// 展开后的本质
rknnModel::infer(m_models[modelId].get(), inputData);
//               ↑ this 指针              ↑ 函数参数
```

### 为什么需要互斥锁

```cpp
// 因为多个线程可能访问同一个对象的成员变量
// 必须加锁保护

rknn::ModelResult rknn::Model::inference(cv::Mat img) {
    std::lock_guard<std::mutex> lock(m_inferenceMtx);  // 必须！
    m_img = img.clone();  // 写入成员变量
    // ...
}
```

### 记忆要点

1. **传指针，不传数据**：`shared_ptr` 只有8字节，成员变量不被复制
2. **共享同一对象**：多个线程通过同一指针访问同一对象
3. **this 是关键**：成员函数通过 `this` 访问所有成员变量
4. **必须加锁**：共享对象的成员变量需要互斥锁保护
